#!/usr/bin/env bash

SCRIPT="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

MODE=${MODE:-asymmetric_key}
CONFIG=${CONFIG:-rabbitmq.config}
IMAGE_TAG=${IMAGE_TAG:-3.10.0-rc.6-management}
IMAGE=${IMAGE:-rabbitmq}

if [ "${MODE}" == "azure" ]; then
  EXTRA_PORTS="-p 15671:15671"
  EXTRA_MOUNTS="-v $SCRIPT/../conf/${MODE}/rabbitmq-ca.crt:/etc/rabbitmq/rabbitmq-ca.crt \
                -v $SCRIPT/../conf/${MODE}/rabbitmq.key:/etc/rabbitmq/rabbitmq.key \
                -v $SCRIPT/../conf/${MODE}/rabbitmq.crt:/etc/rabbitmq/rabbitmq.crt"
fi

docker network inspect rabbitmq_net >/dev/null 2>&1 || docker network create rabbitmq_net
docker rm -f rabbitmq 2>/dev/null || echo "rabbitmq was not running"
echo "running RabbitMQ with mode $MODE"
docker run -d --name rabbitmq --net rabbitmq_net \
    -p 15672:15672 -p 5672:5672 ${EXTRA_PORTS}\
    -v ${SCRIPT}/../conf/${MODE}/${CONFIG}:/etc/rabbitmq/rabbitmq.config:ro \
    -v ${SCRIPT}/../conf/enabled_plugins:/etc/rabbitmq/enabled_plugins \
    -v ${SCRIPT}/../conf:/conf ${EXTRA_MOUNTS} ${IMAGE}:${IMAGE_TAG}
