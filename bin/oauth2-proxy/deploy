#!/usr/bin/env bash

SCRIPT="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

ROOT=$SCRIPT/../..
CONF_DIR=${ROOT}/conf/oauth2-proxy
CERTS_DIR=${CONF_DIR}/certs
KEYCLOAK_CERTS_DIR=${ROOT}/conf/keycloak/certs

source $SCRIPT/../common

ensure_docker_network
docker-compose -f $CONF_DIR/compose.yml down 2>/dev/null || echo "oauth2-proxy was not running"

generate-ca-server-client-kpi oauth2-proxy $CERTS_DIR
generate-ca-server-client-kpi keycloak $KEYCLOAK_CERTS_DIR

begin "Running oauth2-proxy docker image with keycloak as oauth-provider ..."

export OAUTH2_PROXY_COOKIE_SECRET=`dd if=/dev/urandom bs=32 count=1 2>/dev/null | base64 | tr -d -- '\n' | tr -- '+/' '-_' ; echo`

docker-compose -f $CONF_DIR/compose.yml up -d
