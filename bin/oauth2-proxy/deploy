#!/usr/bin/env bash

SCRIPT="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

ROOT=$SCRIPT/../..
CONF_DIR=${ROOT}/conf/oauth2-proxy
CERTS_DIR=${CONF_DIR}/certs

source $SCRIPT/../common

ensure_docker_network
docker-compose -f $CONF_DIR/compose.yml down 2>/dev/null || echo "oauth2-proxy was not running"

if [[ ! -d "${CERTS_DIR}" ]]; then  
    generate-ca-server-client-kpi oauth2-proxy $CERTS_DIR
fi 

begin "Running oauth2-proxy docker image ..."

export OAUTH2_PROXY_COOKIE_SECRET=`python -c 'import os,base64; print(base64.b64encode(os.urandom(16)).decode("ascii"))'`
docker-compose -f $CONF_DIR/compose.yml up
